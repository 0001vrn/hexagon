# -*- mode: ruby -*-
# vi: set ft=ruby :

require_relative 'systems/vagrant.rb'

#
# Disable default shared folder.
#
# WARN: Install Vagrant from HashiCorp's packages, Linux distributions' ones can be broken
#
# sudo vagrant plugin install vagrant-digitalocean
# vagrant plugin install vagrant-digitalocean
#
# For a complete reference, please see the online documentation at: https://docs.vagrantup.com
#
Vagrant.configure(2) do |config|
  config.vm.box = 'jamming/centos_java'
  config.vm.synced_folder '.', '/vagrant', disabled: true
  config.vm.network :private_network, ip: '10.1.1.10'
  config.vm.hostname = 'benchmark'
  config.vm.post_up_message = "#{config.vm.hostname} UP"

  config.vm.provider :virtualbox do |vb|
    vb.name = config.vm.hostname
    vb.cpus = 4
    vb.memory = 2048
    vb.customize [:modifyvm, :id, '--paravirtprovider', 'kvm']
    vb.customize [:modifyvm, :id, '--cpuexecutioncap', '90']
  end

  upload config, 'benchmark/build/install/benchmark', '~'
  upload config, 'benchmark/build/libs/ROOT.war', '~/ROOT.war'

  install_dbs config
  install_resin config

  command config,
    'sudo mv -f /home/vagrant/benchmark /opt || true',
    'sudo rm -f /etc/systemd/system/benchmark.service',
    'sudo mv -f /opt/benchmark/bin/benchmark.service /etc/systemd/system || true',
    'sudo systemctl start benchmark',
    'sudo systemctl enable benchmark'
end
