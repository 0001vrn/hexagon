# -*- mode: ruby -*-
# vi: set ft=ruby :

require 'yaml'
require_relative 'vagrant.rb'

#
# Disable default shared folder.
#
# WARN: Install Vagrant from HashiCorp's packages, Linux distributions' ones can be broken
#
# sudo vagrant plugin install vagrant-digitalocean
# vagrant plugin install vagrant-digitalocean
#
# For a complete reference, please see the online documentation at: https://docs.vagrantup.com
#
Vagrant.configure(2) do |config|
  config.vm.box = 'jamming/centos_java'
  config.vm.synced_folder '.', '/vagrant', disabled: true
  config.vm.hostname = $project_name
  config.vm.post_up_message = "<#{$project_name}> UP"

  config.vm.provider :digital_ocean do |provider, override|
    digitalOceanSettings = YAML::load_file('/home/jam/.vagrant.d/digitalOcean.yaml')

    override.ssh.private_key_path = "~/.ssh/#{digitalOceanSettings['sshKey']}"

    override.vm.box = 'digital_ocean'
    override.vm.box_url =
      'https://github.com/devopsgroup-io/vagrant-digitalocean/raw/master/box/digital_ocean.box'

    provider.ssh_key_name = digitalOceanSettings['sshKey']
    provider.token = digitalOceanSettings['apiKey']
    provider.image = 'centos-7-2-x64'
    provider.region = 'lon1'
    provider.size = '8gb'
  end

  installDbs config

  # noinspection RubyLiteralArrayInspection
  upload config,
    [ "../benchmark/build/install/#{$project_name}", '~' ],
    [ '../benchmark/build/libs/ROOT.war', '~/ROOT.war' ]

  resin = "#{$resin_url}/#{$resin_version}/x86_64/resin-#{$resin_version}-1.x86_64.rpm"
  command config,
    "yum -q -y install wget java-1.8.0-openjdk-devel #{resin} || true",
    'sudo rm -rf /var/resin/webapps/*',
    'sudo mv -f /root/ROOT.war /var/resin/webapps',
    'sudo systemctl start resin',
    'sudo systemctl enable resin',
    'sudo systemctl enable firewalld',
    'sudo systemctl start firewalld',
    'sudo firewall-cmd --permanent --add-port=9090/tcp',
    'sudo firewall-cmd --permanent --add-port=8080/tcp',
    'sudo firewall-cmd --reload'

  command config,
    "sudo mv -f /root/#{$project_name} /opt || true",
    "sudo mv -f /opt/#{$project_name}/bin/#{$project_name}.service /etc/systemd/system || true",
    "sudo systemctl enable #{$project_name}",
    "sudo systemctl start #{$project_name}"
end
