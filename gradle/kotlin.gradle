/*
 * Kotlin development
 * For parallel test execution you need to define a property called 'testsConcurrency' with
 * parallelization type (check Gradle's parallel property)
 */

apply plugin: 'kotlin'
apply plugin: 'jacoco'
apply plugin: 'org.jetbrains.dokka'

ext.testngVersion = findProperty ('testngVersion') ?: '6.10'
ext.mockitoVersion = findProperty ('mockitoVersion') ?: '2.3.11'
ext.powermockVersion = findProperty ('powermockVersion') ?: '1.6.6'

ext.filterPatterns = findProperty ('filterPatterns') ?: '*.properties, *.txt, *.xml, *.json, *.yaml'
ext.rootBuildDir = rootProject.buildDir

defaultTasks 'build'

repositories {
    jcenter ()
    mavenCentral ()
    mavenLocal ()
}

dependencies {
    compile "org.jetbrains.kotlin:kotlin-reflect:$kotlinVersion"

    testCompile "org.jetbrains.kotlin:kotlin-test:$kotlinVersion"
    testCompile "org.testng:testng:$testngVersion"
    testCompile "org.mockito:mockito-core:$mockitoVersion"
    testCompile "org.powermock:powermock-module-testng:$powermockVersion"
    testCompile "org.powermock:powermock-module-test-mockito-testng:$powermockVersion"
}

processResources {
    filterPatterns.split(',').each { String pattern ->
        filesMatching ('**/' + pattern.trim ()) {
            filter {
                it
                    .replace ('${projectVersion}', project.version.toString())
                    .replace ('${projectName}', project.name)
                    .replace ('${projectGroup}', project.group)
                    .replace ('${projectDescription}', project.description)
            }
        }
    }
}

clean {
    delete "build", ".gradle"

    delete fileTree(rootDir) { include '**/*.log' }
    delete fileTree(rootDir) { include '**/*.hprof' }
    delete fileTree(rootDir) { include '**/*.class' }
}

test {
    useTestNG ()

    testLogging {
        if (System.getProperty ('showOutput') != null)
            events 'skipped', 'failed', 'standardOut', 'standardError'
        else
            events 'skipped', 'failed'
    }

    if (project.ext.has ('testsConcurrency')) {
        options.parallel = testsConcurrency
        options.threadCount = Runtime.runtime.availableProcessors ()
    }
}

dokka {
    outputFormat = 'javadoc'
}

jacocoTestReport {
    dependsOn "test"
    reports {
        xml.enabled = true
        html.enabled = true
    }
}
