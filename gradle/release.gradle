
buildscript {
    repositories { jcenter () }
    dependencies {
        classpath 'org.ajoberstar:gradle-git:1.7.2'
    }
}

import org.ajoberstar.grgit.Grgit
import org.ajoberstar.grgit.Credentials

ext.grgit = Grgit.open()

// TODO Check version was changed
task release(dependsOn: [ 'checkGitStatus', 'publish' ]) {
    doLast {
        grgit.tag.add {
            name = version
            message = "Release $version"
        }
        // TODO Push tags
    }
}

task checkGitStatus () {
    doLast {
        checkCleanRepository(grgit)
//        Credentials credentials = new Credentials(System.getenv ('GRGIT_USER') ?: 'token', null)
        grgit.pull (remote: 'origin', branch: 'master')//, credentials: credentials)
        grgit.pull (remote: 'origin', branch: 'develop')//, credentials: credentials)
        checkCleanRepository(grgit)
    }
}

static void checkCleanRepository(Grgit gitRepository) {
    if (!gitRepository.status ().clean)
        throw new GradleException ('Repository not clean')
}
